{% extends sitebase.html %}
{% block head %}
<link rel="stylesheet" href="{% raw qiita_config.portal_dir %}/static/vendor/css/ol.css" type="text/css">
<style type="text/css">
  #map-canvas { height: 500px; }
</style>
<script src="{% raw qiita_config.portal_dir %}/static/vendor/js/ol.js"></script>

<script type="text/javascript">
  $( document ).ready(function() {
    // -> Borrowed from https://stackoverflow.com/q/32102584

    // Creating the markers
    var iconStyle = new ol.style.Style({
      image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
        anchor: [0.5, 46],
        anchorXUnits: 'fraction',
        anchorYUnits: 'pixels',
        opacity: 0.75,
        src: '{% raw qiita_config.portal_dir %}/static/img/qiita-pointer.png'
      }))
    });
    // internal function to avoid duplication of code
    function _generate_iconFeature(lat, long) {
      var iconFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.transform([long, lat], 'EPSG:4326',
        'EPSG:3857')),
        name: 'Null Island',
        population: 4000,
        rainfall: 500
      });
      iconFeature.setStyle(iconStyle);
      return iconFeature;
    }
    // adding features via the lat/long
    var iconFeatures = [];
    {% for lat, lng in lat_longs %}
      iconFeatures.push(_generate_iconFeature(lat, long));
    {% end %}
    // creating new verctor &layer for the markers
    var vectorSource = new ol.source.Vector({ features: [] });
    vectorSource.addFeatures(iconFeatures);
    var vectorLayer = new ol.layer.Vector({ source: vectorSource });
    // creating map
    var map = new ol.Map({
      target: 'map-canvas',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        }),
        vectorLayer
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([-105.24827, 40.01027]),
        zoom: 4
      })
    });
  });

</script>

{% end %}
{% block content %}
  <div id="jumbotron" class="jumbotron">
    <small>Generated on: {{time}}</small>
    <br/><br/>
    <table width="100%">
    <thead>
      <tr>
        <th>Studies</th>
        <th>Samples</th>
        <th>Users</th>
        <th>Jobs</th>
      </tr>
    </thead>
      <tr>
        <td>
          {% for k in number_studies %}
            <i>{{k}}</i>: {{ "{:,}".format(int(number_studies[k])) }} <br/>
          {% end %}
          {% if num_studies_ebi and num_studies_ebi is not None %}
            <i>submitted to EBI</i>: {{ "{:,}".format(int(num_studies_ebi)) }}
          {% end %}
        </td>
        <td>
          {% for k in number_of_samples %}
            <i>{{k}}</i>: {{ "{:,}".format(int(number_of_samples[k])) }} <br/>
          {% end %}
          {% if num_samples_ebi and num_samples_ebi is not None %}
            <i>submitted to EBI</i>: {{ "{:,}".format(int(num_samples_ebi)) }} <br/>
          {% end %}
          {% if number_samples_ebi_prep and number_samples_ebi_prep is not None %}
            <i>submitted to EBI (prep)</i>: {{ "{:,}".format(int(number_samples_ebi_prep)) }}
          {% end %}
        </td>

        {% if num_users and num_users is not None %}
          <td>{{ "{:,}".format(int(num_users)) }}</td>
        {% end %}

        {% if num_processing_jobs and num_processing_jobs is not None %}
          <td>{{ "{:,}".format(int(num_processing_jobs)) }}</td>
        {% end %}
      </tr>
    </table>
  </div>

  <div id="map-canvas"></div>

  {% if random_study_id is not None %}
    <div id="jumbotron" class="jumbotron">
      <h2>Check out this random public study from the database!</h2>
      <h3>{{ random_study_title }}</h3>
      <p align="justify">{{ random_study_info['study_abstract'] }}</p>
      <p>
      {% if user is not None %}
          <a href="{% raw qiita_config.portal_dir %}/study/description/{{ random_study_id }}">Go to the study <span class="glyphicon glyphicon-arrow-right"></span></a>
      {% else %}
          <h4>Log in above to see this and other public studies</h4>
      {% end %}
      </p>
    </div>
  {% end %}

  {% if img and img is not None %}
    <div>
      <h5>Data usage</h5>
      <img height="100%" width="100%" src="{% raw img %}"/>
    </div>
  {% end %}

{% end %}
