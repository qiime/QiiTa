{% extends sitebase.html%}

{%block head%}


{%end%}

{%block content%}
{% from os.path import basename %}
{% from future.utils import viewitems %}


<div class="row">
  <table border="0">
    <tr>
      <td><h1>&nbsp;Analysis: <u>{{aname}}</u></h1></td>
      <td width="20px"></td>
      <td>
        <h1><a class="btn btn-danger glyphicon glyphicon-trash" onclick="delete_analysis();"></a></h1>
      </td>
    </tr>
  </table>

  {% if status == "altered_data" %}
    <h2 style="color:red">UNDERLYING DATA FOR THIS ANALYSIS HAS CHANGED. CONSIDER RE-RUNNING THIS ANALYSIS.</h2>
    {% for change in changes %}
        <p>{{change}}</p>
      {% end %}
    {% if changes == {} %}
      <b> One or more sample/prep templates were deleted. Consider re-creating this analysis completely.</b>
    {% end %}
  {% end %}
</div>


<div class="row" width='100%'>
  <div class="col-md-12">
    <div class="panel-group" id="accordion">
      {% if dropped %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><a data-toggle="collapse" data-parent="#accordion" href="#dropped-samples">Dropped Samples</a></h3>
          </div>
          <div id="dropped-samples" class="panel-collapse collapse">
              <div class="panel-body">
                  {% for data_type, studies in viewitems(dropped) %}
                    <b><u>{{data_type}}</u></b>
                    <br/><br/>
                    {% for title, num_samples, samples in studies %}
                      <b>{{title}}:</b>
                      <br/>
                      Total dropped: {{num_samples}}
                      <br/>
                      {{samples}}<br/>
                    {% end %}
                    <hr>
                  {% end %}
              </div>
          </div>
        </div>
      {% end %}
    </div>
  </div>
</div>

<div class="row" width='100%'>
  <div class="col-md-2">
    <div class="panel-group" id="accordion">
      {% for data_type, jobs in jobres.items() %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><a data-toggle="collapse" data-parent="#accordion" href="#{{data_type}}">{{data_type}}</a></h3>
          </div>
          <div id="{{data_type}}" class="panel-collapse collapse">
            {% for job, results in jobs%}
              <div class="panel-body">
                {{job}}<br />
                {% if len(results) == 0 %}
                  <h3 style="color:red">ERROR</h3>
                {% end %}
                {%for result in results%}
                  <a href='{{"/results/%s" % result}}' target="resframe">{{basename(result)}}</a><br />
                {% end %}
              </div>
            {% end %}
          </div>
        </div>
      {% end %}
    </div>
  </div>
  <div class="col-md-10">
      <iframe id="resframe" name="resframe" width="100%" height="900" frameBorder=0></iframe>
  </div>
</div>


<script>

function delete_analysis() {
  if (confirm('Are you sure you want to delete analysis: {{aname}}?')) {
    var form = $("<form>")
    .attr("action", window.location.href)
    .attr("method", "post")
    .append($("<input>")
    .attr("type", "hidden")
    .attr("name", "analysis_id")
    .attr("value", {{analysis_id}}))
    .append($("<input>")
    .attr("type", "hidden")
    .attr("name", "action")
    .attr("value", "delete_analysis"));
    $("body").append(form);
    form.submit();
  }
}

</script>
{%end%}
