{% extends sitebase.html %}
{% block head %}
<script type="text/javascript">

  function createJobHTML(data, target) {
    target = "#" + target;
    $(target).empty();
    var keys = ['job_id', 'job_status', 'job_step'];
    var d = $("<div>").appendTo(target);
    for(var i in keys) {
      if (data[keys[i]]) {
        d.append("<b>" + keys[i].replace('_', ' ') + ": </b> " + data[keys[i]] + "</br>");
      }
    }
    d.append("<b> job parameters: </b></br>");
    for(var key in data.job_parameters) {
      d.append("<i>" + key + ":</i> " + data.job_parameters[key] + "</br>");
    }
  }

  function populateContentArtifact(artifactId) {
    // Put the loading gif in the div
    show_loading('{% raw qiita_config.portal_dir %}', 'analysis-results');
    $.get('{% raw qiita_config.portal_dir %}/study/description/artifact_summary/', {'artifact_id': artifactId}, function(data){
      $("#analysis-results").html(data);
    })
      .fail(function(object, status, error_msg) {
        $("#analysis-results").html("Error loading artifact information: " + status + " " + error_msg);
      }
    );
  };

  function populateContentJob(jobId) {
    // Put the loading gif in the div
    show_loading('{% raw qiita_config.portal_dir %}', 'analysis-results');
    $.get('{% raw qiita_config.portal_dir %}/study/process/job/', {job_id: jobId}, function(data){
      createJobHTML(data, "analysis-results");
    })
      .fail(function(object, status, error_msg) {
        $("#analysis-results").html("Error loading artifact information: " + status + " " + error_msg);
      }
    );
  };

  /*
   * Toggle the graph view
   *
   * Show/hide the graph div and update GUI accordingly
   *
   */
  function toggle_network_graph() {
    if($("#analysis-network-div").css('display') == 'none' ) {
      $("#analysis-network-div").show();
      $("#show-hide-network-btn").text("-");
    } else {
      $("#analysis-network-div").hide();
      $("#show-hide-network-btn").text("+");
    }
  };

  function populate_grap_div() {
    // Put the loading gif in the div
    show_loading('{% raw qiita_config.portal_dir %}', 'analysis-network-div');
    // Retrieve the information for the graph
    $.get("{% raw qiita_config.portal_dir %}/analysis/description/graph/", { analysis_id: {{analysis_id}}}, function(data) {
      var nodes = [];
      var edges = [];
      // Format edge list data
      for(var i = 0; i < data.edges.length; i++) {
        edges.push({from: data.edges[i][0], to: data.edges[i][1], arrows:'to'});
      }
      // Format node list data
      for(var i = 0; i < data.nodes.length; i++) {
        nodes.push({id: data.nodes[i][1], label: data.nodes[i][2], group: data.nodes[i][0]});
      }
      draw_processing_graph(nodes, edges, 'analysis-network-div', populateContentArtifact, populateContentJob);
    })
      .fail(function(object, status, error_msg) {
        $("#analysis-network-div").html("Error loading graph: " + status + " " + error_msg);
      }
    );
  }

  $(document).ready(function(){
    populate_grap_div();
  });

</script>
<style>
.graph {
  width:100%;
  height:300px;
  border: 1px solid #ccc;
}
</style>
{% end %}
{% block content %}

<div class="row">
  <div class="col">
    <h2>{{analysis_name}} - ID {{analysis_id}}</h2>
    <h3>{{analysis_description}}</h3>
  </div>
</div>
<div class="row">
  <div class="col">
    <h4><a class="btn btn-info" id="show-hide-network-btn" onclick="toggle_network_graph();">-</a><i> Processing network</i></h4>
    <b>(Click nodes for more information, blue are jobs)</b>
  </div>
</div>
<div class='row'>
  <div class='col-md-12 graph' style='width:90%' id='analysis-network-div'>
  </div>
</div>
<div class='row'>
  <div class='col-md-12' style='width:90%' id='analysis-results'>
  </div>
</div>

{% end %}
