{% extends sitebase.html %}
{% block content %}

<div class="container">

  <div class="row">
    <b>Uploading files for: {{study_title}} ({{study_info['study_alias']}})</b>
    <br/><br/>
    Currently we can process (<b>{{extensions.replace(',',', ')}}</b>):
    <ul>
      <li>Note that '.zip' files can not be processed.</li>
      <li>Note that '.fasta' and '.fna' files require '.qual' files for submission.</li>
      <li>Note that '.txt.' files must be tab separated and require the extension .txt.</li>
    </ul>
  </div>

  <div class="row" align="center">
    <a href="{% raw qiita_config.portal_dir %}/study/description/{{study_id}}">&lt;&lt; Go to study description</a>
  </div>

  <div class="row">
    <div class="panel-group" id="accordion">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
              Upload via Local Machine
            </a>
          </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse">
          <div class="row" align="center">
            <b>Upload files locally (max file size: {% if max_upload_size/1000==0 %} {{max_upload_size}} GB{% else %} {{max_upload_size/1000.0}} TB{% end %})</b>
          </div>

          <div style="height: 150px; width: 100%; background-color:lightgrey; border: 2px solid; border-radius: 25px;" class="resumable-drop-metadata" ondragenter="jQuery(this).addClass('resumable-dragover');" ondragend="jQuery(this).removeClass('resumable-dragover');" ondrop="jQuery(this).removeClass('resumable-dragover');">
            <div align="center">
              <p style="vertical-align: middle;">Drop files here to upload or <a class="resumable-browse-metadata"><u>select from your computer</u></a></p>
            </div>
          </div>

            <div class="progress-metadata" style="display:none;">
              <table>
                <tr>
                  <td width="100%"><div class="progress-container"><div class="progress-bar"></div></div></td>
                  <td class="progress-text" nowrap="nowrap"></td>
                  <td class="progress-pause" nowrap="nowrap">
                    &nbsp;&nbsp;&nbsp;&nbsp;
                    <a href="#" onclick="uploader.resumable.upload(); $('#uploader_status').html('~~ Uploading ~~'); return(false);" class="progress-resume-link"><span class="glyphicon glyphicon-play"></span></a>
                    <a href="#" onclick="uploader.resumable.pause(); $('#uploader_status').html('~~ Paused ~~'); return(false);" class="progress-pause-link"><span class="glyphicon glyphicon-pause"></span></a>
                  </td>
                </tr>
                <tr>
                  <td colspan="3">
                    <div class="blinking-message">
                      <div id="uploader_status"></div>
                      Keep track of your upload or pause/resume it! <span class="glyphicon glyphicon-arrow-up"></span>
                      <br/>
                      <small>Your upload won't be interrupted if you change networks or you close your computer, just make sure you don't leave this page. </small>
                    </div>
                  </td>
                <tr>
              </table>
            </div>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
              Upload via Remote Server
            </a>
          </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse">
          <div class="container">
            <div class="row">
              <b>Steps:</b>
              <ol>
                <li>Prepare study files by storing them in one folder on your fileserver.</li>
                <li>Configure login keys by following instructions <a href="tempurl">here</a>.</li>
                <li>Enter the URL to the remote directory. We currently support sftp and scp.</li>
                <li>Press 'List Files' to test the connection and verify the list of study files.</li>
                <li>If the connection is made and files are correct, press 'Transfer Files' to initiate the transfer.</li>
              </ol>
            </div>
            <div class="row">
              <form class="form-horizontal">
                <div class="form-group">
                  <label for="inputURL" class="col-md-1 control-label">URL</label>
                  <div class="col-md-9">
                    <input type="email" class="form-control" id="inputURL" placeholder="scp://user@university.edu:/folder/">
                  </div>
                  <button type="button" class="btn btn-default col-md-1" onclick="">List Files</button>
                </div>
              </form>
          </div>
          <button type="button" class="btn btn-default" onclick="">Transfer Files</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr>
  <div class="row" align="center">
    <h3><u>Files</u></h3>
    <table align="center" border="0">
      <tr>
        <td>
          <button type="button" class="btn btn-default" onclick="$('input[name*=\'files_to_erase\']').prop('checked', true);">Select All</button>
        </td>
        <td width="30px">&nbsp;</td>
        <td>
          <button type="button" class="btn btn-default" onclick="$('input[name*=\'files_to_erase\']').removeAttr('checked');">Unselect All</button>
        </td>
      </tr>
    </table>
  </div>

  <div class="row", align="center">
    <form method="post" id="delete-files-form">
      <div class="uploader-list" style="display:none;">
      </div>
    </form>
    <div class="file-edit-container" style="display:none;">
    </div>
    &nbsp;
    <button type="button" class="btn btn-danger" onclick="if(confirm('Are you sure you want to delete the selected files? You can not undo this action')) { $('#delete-files-form').submit() }">
      <span class="glyphicon glyphicon-trash"></span> Delete selected files
    </button>
  </div>
</div>


<div style='width:inherit;text-align:center;padding-top:30px'>
  <small><a href="{% raw qiita_config.portal_dir %}/study/description/{{study_id}}">&lt;&lt; Go to study description</a></small>
</div>



<!-- Upload required files and JS code -->
<script src="{% raw qiita_config.portal_dir %}/static/vendor/js/resumable.js"></script>
<script src="{% raw qiita_config.portal_dir %}/static/vendor/js/resumable-uploader.js"></script>
<script src="{% raw qiita_config.portal_dir %}/static/vendor/js/underscore.min.js"></script>
<script src="{% raw qiita_config.portal_dir %}/static/vendor/js/string.min.js"></script>

<script>
  var meta = { fileType: [] };
  var maxFileSize = {{max_upload_size}}; // in GB

  uploader = (function($){
      return (new ResumableUploader(meta, $('.resumable-browse-metadata'),
                                    $('.resumable-drop-metadata'), $('.progress-metadata'),
                                    $('.uploader-list'), $('.file-edit-container'),
                                    maxFileSize, "{{study_id}}", "{{extensions}}",
                                    "{% raw qiita_config.portal_dir %}", '{{is_admin}}'=='True',
                                    '{% raw qiita_config.portal_dir %}/download_upload/{{study_id}}/'));
    })(jQuery);

  {% for dirid, filename, size in files %}
    uploader.addFile({ "dirid": "{{dirid}}", "fileName": "{{filename}}", "size": "{{size}}", "uploaded": "True" });
  {% end  %}
</script>

{% end %}
